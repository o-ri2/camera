<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사이트 A - 작가 전용</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            overflow: hidden;
        }
        
        .image-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .image-wrapper {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #baseImage {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover; /* 1920x1080 비율로 크롭 */
        }
        
        #pixelCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        
        .pixel {
            position: absolute;
            animation: fadeIn 0.3s ease-in;
            pointer-events: none;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* 픽셀 하이라이트 효과 */
        .pixel-highlight {
            position: absolute;
            pointer-events: none;
            z-index: 100;
            animation: highlightPulse 1s ease-out forwards;
        }
        
        @keyframes highlightPulse {
            0% {
                box-shadow: 0 0 20px 5px rgba(255, 255, 255, 1),
                            0 0 40px 10px rgba(255, 59, 92, 0.8);
                transform: scale(1.5);
                opacity: 1;
            }
            50% {
                box-shadow: 0 0 30px 10px rgba(255, 255, 255, 0.8),
                            0 0 60px 20px rgba(255, 59, 92, 0.6);
                transform: scale(2);
                opacity: 0.8;
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0),
                            0 0 0 0 rgba(255, 59, 92, 0);
                transform: scale(2.5);
                opacity: 0;
            }
        }
        
        
        /* 하트 카운터 스타일 */
        .heart-counter {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .heart-icon {
            font-size: 24px;
            color: #ff3b5c;
            animation: heartBeat 1s ease-in-out infinite;
        }
        
        .heart-count {
            font-size: 18px;
            font-weight: 600;
            color: white;
            min-width: 30px;
            text-align: center;
        }
        
        @keyframes heartBeat {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        /* 카운터 증가 애니메이션 */
        .heart-counter.pulse {
            animation: counterPulse 0.3s ease-out;
        }
        
        @keyframes counterPulse {
            0% {
                transform: translateX(-50%) scale(1);
            }
            50% {
                transform: translateX(-50%) scale(1.15);
            }
            100% {
                transform: translateX(-50%) scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="image-container">
        <div class="image-wrapper">
            <img id="baseImage" src="image/1.png" alt="Base Image">
            <canvas id="pixelCanvas"></canvas>
        </div>
    </div>
    
    <!-- 하트 카운터 -->
    <div class="heart-counter">
        <span class="heart-icon">♥</span>
        <span class="heart-count" id="heartCount">0</span>
    </div>

    <script>
        let ws = null;
        let heartCount = 0;
        
        const baseImage = document.getElementById('baseImage');
        const canvas = document.getElementById('pixelCanvas');
        const ctx = canvas.getContext('2d');
        const heartCountElement = document.getElementById('heartCount');
        const heartCounterContainer = document.querySelector('.heart-counter');
        
        let secondImage = new Image();
        let imageLoaded = false;
        let revealedPixels = new Set(); // 이미 드러난 픽셀 위치 저장
        
        // 2.png 로드
        secondImage.src = 'image/2.png';
        secondImage.onload = function() {
            imageLoaded = true;
            console.log('2.png 로드 완료');
        };
        
        // 1.png 로드 완료 시 캔버스 크기 설정
        baseImage.onload = function() {
            // 화면 크기에 맞춰 캔버스 크기 설정
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            console.log('1.png 로드 완료, 캔버스 크기:', canvas.width, 'x', canvas.height);
        };
        
        // 창 크기 변경 시 캔버스 크기도 조정
        window.addEventListener('resize', function() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
        
        // 하트 카운터 업데이트 함수
        function updateHeartCount() {
            heartCount++;
            heartCountElement.textContent = heartCount.toLocaleString();
            
            // 펄스 애니메이션 추가
            heartCounterContainer.classList.remove('pulse');
            void heartCounterContainer.offsetWidth;
            heartCounterContainer.classList.add('pulse');
            
            setTimeout(() => {
                heartCounterContainer.classList.remove('pulse');
            }, 300);
        }
        
        // WebSocket URL 자동 감지
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const wsUrl = `${protocol}//${host}`;
        
        console.log('WebSocket URL:', wsUrl);
        
        // WebSocket 연결 설정
        function connectWebSocket() {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket 연결됨');
                
                // 작가로 등록
                ws.send(JSON.stringify({
                    type: 'register',
                    role: 'artist'
                }));
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('받은 메시지:', data);
                
                if (data.type === 'button_click') {
                    handleButtonClick(data.button);
                } else if (data.type === 'viewer_count') {
                    updateViewerCount(data.count);
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket 에러:', error);
            };
            
            ws.onclose = function() {
                console.log('WebSocket 연결 종료');
                
                // 5초 후 재연결 시도
                setTimeout(connectWebSocket, 5000);
            };
        }
        
        // 관람객 수 업데이트
        function updateViewerCount(count) {
            console.log(`현재 관람객: ${count}명`);
        }
        
        // 픽셀 하이라이트 효과 생성
        function createPixelHighlight(x, y, size) {
            const highlight = document.createElement('div');
            highlight.className = 'pixel-highlight';
            highlight.style.left = x + 'px';
            highlight.style.top = y + 'px';
            highlight.style.width = size + 'px';
            highlight.style.height = size + 'px';
            highlight.style.border = '2px solid rgba(255, 255, 255, 0.8)';
            highlight.style.borderRadius = '50%';
            
            const imageWrapper = document.querySelector('.image-wrapper');
            imageWrapper.appendChild(highlight);
            
            setTimeout(() => {
                highlight.remove();
            }, 1000);
        }
        
        // 2.png의 랜덤 픽셀 하나를 드러내기
        function revealPixel() {
            if (!imageLoaded) {
                console.log('2.png가 아직 로드되지 않았습니다.');
                return;
            }
            
            const pixelSize = 10; // 10x10 픽셀 블록
            const cols = Math.floor(canvas.width / pixelSize);
            const rows = Math.floor(canvas.height / pixelSize);
            const totalPixels = cols * rows;
            
            // 모든 픽셀이 드러났는지 확인
            if (revealedPixels.size >= totalPixels) {
                console.log('모든 픽셀이 이미 드러났습니다!');
                return;
            }
            
            // 아직 드러나지 않은 랜덤 위치 찾기
            let x, y, key;
            do {
                x = Math.floor(Math.random() * cols);
                y = Math.floor(Math.random() * rows);
                key = `${x},${y}`;
            } while (revealedPixels.has(key));
            
            // 픽셀 위치 기록
            revealedPixels.add(key);
            
            // 2.png의 해당 부분을 캔버스에 그리기
            const sourceX = x * pixelSize;
            const sourceY = y * pixelSize;
            
            ctx.drawImage(
                secondImage,
                sourceX, sourceY, pixelSize, pixelSize,  // 소스 이미지 영역
                sourceX, sourceY, pixelSize, pixelSize   // 캔버스에 그릴 위치와 크기
            );
            
            // 시각적 효과 추가
            createPixelHighlight(sourceX, sourceY, pixelSize);
            
            console.log(`픽셀 드러남! 위치: (${x}, ${y}) / 총 ${revealedPixels.size}/${totalPixels}개`);
        }
        
        // 버튼 클릭 처리
        function handleButtonClick(buttonName) {
            switch(buttonName) {
                case 'button1':
                    revealPixel(); // 2.png의 픽셀 하나 드러내기
                    updateHeartCount(); // 하트 카운터 증가
                    break;
                case 'button2':
                    // 추가 기능이 필요하면 여기에 구현
                    break;
                case 'button3':
                    // 추가 기능이 필요하면 여기에 구현
                    break;
            }
        }
        
        // 페이지 로드 시 WebSocket 연결
        window.addEventListener('load', function() {
            connectWebSocket();
        });
        
        // 페이지 언로드 시 정리
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
